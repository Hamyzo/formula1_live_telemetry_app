<!doctype html>

<html ng-app="angTeleApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.8/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-bootstrap/2.5.0/ui-bootstrap-tpls.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel='stylesheet' type='text/css' href="/style.css"/>
    <script src="/telemetry.js"></script>
    <script src="/port.js"></script>

    <script type = "text/javascript">
        const socket = io();
        socket.on('message', function(msg){
            angular.element($('#telemetryController')).scope().reloadRaces();
            console.log("message: " + msg)
        });
    </script>
</head>
<body class="m-3">
<div id="telemetryController" ng-controller="telemetryController">
    <button ng-click="back()" class="btn btn-outline-secondary"><i class="fa fa-arrow-left"></i> Go back</button>
    <h1>Available Races</h1>
    <div class="form-group form-inline">
        <select class="form-control ml-2" ng-options="race as race.circuit.name + ' - ' + (race.date | date:'d MMM yyyy') + ' (' + race.status + ')' group by race.country for race in races"
                ng-model="race" ng-change="reloadRace()">
            <option value="">-- Select Race To Show --</option>
        </select>
    </div>
    <div class="card mt-3" ng-if="race">
        <div class="ml-0 mr-0 card-header row">
            <div class="col-5">
                <b>{{race.circuit.name}}</b>
            </div>
            <div class="col-3">
                Current Lap: {{race.cars[0].lap_times.length}}
            </div>
            <div class="col-3">
                Elapsed time: {{race.cars[0].total_time}}
            </div>
        </div>
        <div class="card-body" id="race{{race._id}}">
            <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="leaderboard-tab" data-toggle="tab" href="#leaderboard" role="tab" aria-controls="leaderboard" aria-selected="true">Leaderboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="performance-tab" data-toggle="tab" href="#performance" role="tab" aria-controls="performance" aria-selected="false">Performance</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="speed-tab" data-toggle="tab" href="#speed" role="tab" aria-controls="speed" aria-selected="false">Speed</a>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="leaderboard" role="tabpanel" aria-labelledby="leaderboard-tab">
                    <h5 class="card-title">Live leaderboard</h5>
                    <table class="table">
                        <thead>
                        <tr>
                            <th scope="col">POS</th>
                            <th scope="col">#</th>
                            <th scope="col">NAME</th>
                            <th scope="col">LAP</th>
                            <th scope="col">LATEST LAP TIME</th>
                            <th scope="col">S1</th>
                            <th scope="col">S2</th>
                            <th scope="col">S3</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr ng-repeat="car in race.cars">
                            <th scope="row">{{$index + 1}}</th>
                            <td>{{car.car.number}}</td>
                            <td>{{car.car.driver}}</td>
                            <td>{{car.lap_times.length}}</td>
                            <td ng-style="car.laps[car.laps.length - 1] < car.laps[car.laps.length - 2] && {'color':'green'} || {'color': 'orange'}">
                                {{car.laps[car.laps.length - 1]}}s
                                <span style="font-size: 12px">({{(car.laps[car.laps.length - 1] - car.laps[car.laps.length - 2]) > 0 ? "+" : ""}}{{(car.laps[car.laps.length - 1] - car.laps[car.laps.length - 2]) | number : 3}}s)</span>
                            </td>
                            <td ng-style="car.lap_times[car.lap_times.length - 1][0] < car.lap_times[car.lap_times.length - 2][0] && {'color':'green'} || {'color': 'orange'}">
                                {{car.lap_times[car.lap_times.length - 1][0] | number : 3}}s
                                <span style="font-size: 12px">({{(car.lap_times[car.lap_times.length - 1][0] - car.lap_times[car.lap_times.length - 2][0]) > 0 ? "+" : ""}}{{(car.lap_times[car.lap_times.length - 1][0] - car.lap_times[car.lap_times.length - 2][0]) | number : 3}}s)</span>
                            </td>
                            <td ng-style="car.lap_times[car.lap_times.length - 1][1] < car.lap_times[car.lap_times.length - 2][1] && {'color':'green'} || {'color': 'orange'}">
                                {{car.lap_times[car.lap_times.length - 1][1] | number : 3}}s
                                <span style="font-size: 12px">({{(car.lap_times[car.lap_times.length - 1][1] - car.lap_times[car.lap_times.length - 2][1]) > 0 ? "+" : ""}}{{(car.lap_times[car.lap_times.length - 1][1] - car.lap_times[car.lap_times.length - 2][1]) | number : 3}}s)</span>
                            </td>
                            <td ng-style="car.lap_times[car.lap_times.length - 1][2] < car.lap_times[car.lap_times.length - 2][2] && {'color':'green'} || {'color': 'orange'}">
                                {{car.lap_times[car.lap_times.length - 1][2] | number : 3}}s
                                <span style="font-size: 12px">({{(car.lap_times[car.lap_times.length - 1][2] - car.lap_times[car.lap_times.length - 2][2]) > 0 ? "+" : ""}}{{(car.lap_times[car.lap_times.length - 1][2] - car.lap_times[car.lap_times.length - 2][2]) | number : 3}}s)</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="tab-pane fade" id="performance" role="tabpanel" aria-labelledby="performance-tab">
                    <div class="row">
                        <div class="col-3">
                            <h5 class="card-title">Top lap times</h5>
                            <ul class="list-group">
                                <li ng-repeat="i in [0, 1, 2, 3, 4]" class="list-group-item">
                                    {{lap_times[i].time}}s <span class="float-right">{{lap_times[i].car.car.driver}}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-3">
                            <h5 class="card-title">Top Sector 1 times</h5>
                            <ul class="list-group">
                                <li ng-repeat="i in [0, 1, 2, 3, 4]" class="list-group-item">
                                    {{sector_times[0][i].time}}s <span class="float-right">{{sector_times[0][i].car.car.driver}}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-3">
                            <h5 class="card-title">Top Sector 2 times</h5>
                            <ul class="list-group">
                                <li ng-repeat="i in [0, 1, 2, 3, 4]" class="list-group-item">
                                    {{sector_times[1][i].time}}s <span class="float-right">{{sector_times[1][i].car.car.driver}}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-3">
                            <h5 class="card-title">Top Sector 3 times</h5>
                            <ul class="list-group">
                                <li ng-repeat="i in [0, 1, 2, 3, 4]" class="list-group-item">
                                    {{sector_times[2][i].time}}s <span class="float-right">{{sector_times[2][i].car.car.driver}}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="speed" role="tabpanel" aria-labelledby="speed-tab">
                    <div class="row">
                        <div class="col-3">
                            <h5 class="card-title">Top lap speeds</h5>
                            <ul class="list-group">
                                <li ng-repeat="i in [0, 1, 2, 3, 4]" class="list-group-item">
                                    {{race.circuit.lap_distance/(lap_times[i].time/3600) | number: 0}}km/h <span class="float-right">{{lap_times[i].car.car.driver}}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-3">
                            <h5 class="card-title">Top Sector 1 speeds</h5>
                            <ul class="list-group">
                                <li ng-repeat="i in [0, 1, 2, 3, 4]" class="list-group-item">
                                    {{(race.circuit.lap_distance/3)/(lap_times[i].time/3600) | number: 0}}km/h <span class="float-right">{{lap_times[i].car.car.driver}}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-3">
                            <h5 class="card-title">Top Sector 2 speeds</h5>
                            <ul class="list-group">
                                <li ng-repeat="i in [0, 1, 2, 3, 4]" class="list-group-item">
                                    {{(race.circuit.lap_distance/3)/(lap_times[i].time/3600) | number: 0}}km/h <span class="float-right">{{lap_times[i].car.car.driver}}</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-3">
                            <h5 class="card-title">Top Sector 3 speeds</h5>
                            <ul class="list-group">
                                <li ng-repeat="i in [0, 1, 2, 3, 4]" class="list-group-item">
                                    {{(race.circuit.lap_distance/3)/(lap_times[i].time/3600) | number: 0}}km/h <span class="float-right">{{lap_times[i].car.car.driver}}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>